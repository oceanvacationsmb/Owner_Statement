<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#fff;
color:#000;
}

.topbar{
background:#f3f3f3;
padding:10px;
display:flex;
justify-content:center;
gap:8px;
flex-wrap:wrap;
border-bottom:1px solid #ccc;
}

select,input,button{
padding:5px;
font-size:12px;
}

button{
background:#000;
color:#fff;
border:none;
cursor:pointer;
}

.content{
max-width:1000px;
margin:auto;
padding:20px;
}

.company{
font-size:30px;
font-weight:900;
text-align:center;
margin-bottom:10px;
}

.title{
font-size:34px;
font-weight:900;
text-align:center;
letter-spacing:1px;
}

.period{
text-align:center;
font-size:14px;
margin-top:5px;
}

.owner{
font-size:28px;
font-weight:bold;
text-align:center;
margin-top:10px;
}

.summary{
display:flex;
justify-content:space-between;
margin:25px 0;
font-size:13px;
flex-wrap:wrap;
}

.summary div{
text-align:center;
flex:1;
}

.summary span{
display:block;
font-size:18px;
font-weight:bold;
margin-top:4px;
}

.property{
margin-top:30px;
page-break-inside:avoid;
}

.property h3{
margin-bottom:3px;
}

.property small{
display:block;
margin-bottom:6px;
font-size:12px;
}

table{
width:100%;
border-collapse:collapse;
margin-top:5px;
font-size:12px;
}

th,td{
border:1px solid #000;
padding:4px;
text-align:center;
}

th{
background:#000;
color:#fff;
}

tr:nth-child(even){
background:#f2f2f2;
}

.total{
font-weight:bold;
}

.delete-btn{
background:red;
color:white;
border:none;
padding:3px 6px;
cursor:pointer;
font-size:11px;
}

.expense-btn{
margin-top:6px;
background:#444;
color:#fff;
padding:4px 8px;
font-size:11px;
}

@media print{
.topbar{display:none}
.property{page-break-before:always}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<select id="percent" disabled></select>
<select id="type" disabled></select>
<input type="file" id="fileInput" accept=".csv">
<button onclick="runStatement()">Run Report</button>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="output" class="content"></div>

<script>

const owners={
"ERAN MARON":{percent:0.12,type:"Draft"},
"GHO":{percent:0.10,type:"Payout"},
"1463 Basin Trail":{percent:0.12,type:"Payout"},
"113B-15S Surfside Beach":{percent:0.12,type:"Payout"},
"113B-13N Surfside Beach":{percent:0.12,type:"Payout"},
"115C-15N Surfside Beach":{percent:0.12,type:"Payout"},
"2131 Sanibel Myrtle Beach":{percent:0.15,type:"Payout"},
"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"Payout"},
"469C White River RD Myrtle Beach":{percent:0.12,type:"Payout"},
"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"Payout"},
"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"Payout"},
"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"Payout"},
"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"Payout"}
};

const ownerSel=document.getElementById("owner");
const percentSel=document.getElementById("percent");
const typeSel=document.getElementById("type");

Object.keys(owners).forEach(o=>{
ownerSel.innerHTML+=`<option value="${o}">${o}</option>`;
});

ownerSel.onchange=()=>{
let o=owners[ownerSel.value];
percentSel.innerHTML=`<option>${o.percent*100}%</option>`;
typeSel.innerHTML=`<option>${o.type}</option>`;
};
ownerSel.onchange();

const monthSel=document.getElementById("month");
const yearSel=document.getElementById("year");
const now=new Date();

for(let i=0;i<12;i++){
monthSel.innerHTML+=`<option value="${i+1}">${new Date(0,i).toLocaleString('default',{month:'long'})}</option>`;
}
monthSel.value=now.getMonth()+1;

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSel.innerHTML+=`<option>${y}</option>`;
}
yearSel.value=now.getFullYear();

let expenses=JSON.parse(localStorage.getItem("statement_expenses")||"{}");

function saveExpenses(){
localStorage.setItem("statement_expenses",JSON.stringify(expenses));
}

function money(v){return "$"+Number(v).toFixed(2);}
function num(v){return parseFloat(v)||0;}

function normalizePlatform(p){
p=(p||"").toLowerCase();
if(p.includes("manual")) return "Direct";
if(p.includes("vrbo")) return "VRBO";
return p.charAt(0).toUpperCase()+p.slice(1);
}

function fullPeriod(month,year){
let start=new Date(year,month-1,1);
let end=new Date(year,month,0);
return start.toLocaleDateString("en-US",{month:"long",day:"numeric"})+" â€“ "+
end.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
}

async function runStatement(){

const file=document.getElementById("fileInput").files[0];
if(!file){alert("Upload CSV");return;}

const text=await file.text();
const data=Papa.parse(text,{header:true}).data;

const owner=ownerSel.value;
const {percent,type}=owners[owner];
const month=parseInt(monthSel.value);
const year=parseInt(yearSel.value);

let grouped={};
data.forEach(r=>{
if(!r["CHECK-IN DATE"]) return;
let m=parseInt(r["CHECK-IN DATE"].split("-")[1]);
let y=parseInt(r["CHECK-IN DATE"].split("-")[0]);
if(m!==month||y!==year) return;
let listing=r["LISTING'S NICKNAME"]||"Unknown";
if(!grouped[listing]) grouped[listing]=[];
grouped[listing].push(r);
});

let totalGross=0,totalAcc=0,totalClean=0,totalExpense=0,totalPMC=0,totalDraft=0,totalOwner=0;

let html=`
<div id="statement">
<div class="company">Ocean Vacations Inc</div>
<div class="title">RESERVATION REPORT</div>
<div class="period">${fullPeriod(month,year)}</div>
<div class="owner">${owner}</div>
`;

/* SUMMARY AT TOP */
html+=`
<div class="summary">
<div>GROSS PAYOUT<span id="sumGross"></span></div>
<div>ACCOMMODATION<span id="sumAcc"></span></div>
<div>CLEANING FEE<span id="sumClean"></span></div>
<div>EXPENSES<span id="sumExp"></span></div>
<div>PMC<span id="sumPMC"></span></div>
<div>DRAFT FROM OWNER<span id="sumDraft"></span></div>
</div>
`;

/* properties rendered later... */

html+=`</div>`;

document.getElementById("output").innerHTML=html;

}
</script>

</body>
</html>
