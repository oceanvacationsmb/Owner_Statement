<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Reservation Statement</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#0f172a;
color:#e5e7eb;
}

.topbar{
background:#111827;
padding:12px;
display:flex;
gap:10px;
align-items:center;
flex-wrap:wrap;
}

select,input,button{
padding:8px;
border-radius:6px;
border:none;
font-size:14px;
}

button{
background:#2563eb;
color:white;
cursor:pointer;
}

.content{
padding:40px;
max-width:1100px;
margin:auto;
text-align:center;
}

.owner{
font-size:48px;
color:#facc15;
margin-top:10px;
}

.summary{
display:flex;
justify-content:center;
gap:60px;
margin:30px 0;
font-size:18px;
}

.property{
margin-top:40px;
text-align:left;
}

table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}

th{
background:#1f2937;
color:white;
padding:10px;
text-align:center;
}

td{
padding:10px;
text-align:center;
background:#111827;
}

tr:nth-child(even) td{
background:#1f2937;
}

.total{
font-weight:bold;
background:#374151 !important;
}

.print-only{ display:none; }

/* PRINT / PDF STYLE */
@media print{

body{
background:white;
color:black;
}

.topbar{ display:none; }

.print-only{ display:block; }

table{
page-break-inside:avoid;
}

.property{
page-break-before:always;
}

th{
background:black;
color:white;
}

td{
background:white;
color:black;
border:1px solid #ccc;
}

tr:nth-child(even) td{
background:#f3f4f6;
}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<input type="file" id="file">
<button onclick="run()">Run Statement</button>
<button onclick="window.print()">Export PDF</button>
</div>

<div id="output" class="content"></div>

<script>
const OWNERS={
"ERAN":{rate:0.12,mode:"DRAFT"},
"GHO":{rate:0.10,mode:"PAYOUT"},
"1463 Basin Trail":{rate:0.12,mode:"PAYOUT"},
"113B-15S Surfside":{rate:0.12,mode:"PAYOUT"},
"113B-13N Surfside":{rate:0.12,mode:"PAYOUT"},
"115C-15N Surfside":{rate:0.12,mode:"PAYOUT"},
"2131 Sanibel":{rate:0.15,mode:"PAYOUT"},
"1552 Elizabeth":{rate:0.15,mode:"PAYOUT"},
"469C White River":{rate:0.12,mode:"PAYOUT"},
"4631-301 Wild Iris":{rate:0.12,mode:"PAYOUT"},
"4679-204 Wild Iris":{rate:0.12,mode:"PAYOUT"},
"508 33rd Ave N":{rate:0.15,mode:"PAYOUT"},
"214-2S 2nd Ave S":{rate:0.12,mode:"PAYOUT"}
};

const ownerSel=document.getElementById("owner");
Object.keys(OWNERS).forEach(o=>{
const opt=document.createElement("option");
opt.value=o;
opt.textContent=o;
ownerSel.appendChild(opt);
});

const monthSel=document.getElementById("month");
const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
months.forEach((m,i)=>{
const opt=document.createElement("option");
opt.value=i;
opt.textContent=m;
monthSel.appendChild(opt);
});
monthSel.value=new Date().getMonth();

const yearSel=document.getElementById("year");
for(let y=2024;y<=2030;y++){
const opt=document.createElement("option");
opt.value=y;
opt.textContent=y;
yearSel.appendChild(opt);
}
yearSel.value=new Date().getFullYear();

function money(v){ return "$"+v.toFixed(2); }

function run(){

const file=document.getElementById("file").files[0];
if(!file){ alert("Upload CSV"); return; }

Papa.parse(file,{
header:true,
skipEmptyLines:true,
complete:(res)=>build(res.data)
});
}

function build(rows){

const owner=ownerSel.value;
const {rate,mode}=OWNERS[owner];

let totalAcc=0,totalPMC=0,totalClean=0,totalTaxBase=0;

let properties={};

rows.forEach(r=>{

const prop=r["LISTING'S NICKNAME"]||"Unknown";
const acc=+r["ACCOMMODATION FARE"]||0;
const markup=+r["MARKUP"]||0;
const clean=+r["CLEANING FARE"]||0;
const payout=+r["TOTAL PAYOUT"]||0;

const trueAcc=acc-markup;
const pmc=trueAcc*rate;

if(!properties[prop]) properties[prop]=[];

properties[prop].push({
id:r["CONFIRMATION CODE"],
platform:r["PLATFORM"],
stay:r["CHECK-IN DATE"]+" - "+r["CHECK-OUT DATE"],
acc:trueAcc,
pmc,
clean,
owner: mode==="DRAFT" ? pmc+clean : trueAcc-pmc
});

totalAcc+=trueAcc;
totalPMC+=pmc;
totalClean+=clean;

if(mode==="DRAFT") totalTaxBase+=payout;

});

const out=document.getElementById("output");

let html=`
<div class="print-only">
<h2 style="text-align:center;">RESERVATION STATEMENT</h2>
</div>

<div class="owner">${owner}</div>

<div class="summary">
<div>Accommodation<br><b>${money(totalAcc)}</b></div>
<div>PMC Commission<br><b>${money(totalPMC)}</b></div>
${mode==="DRAFT" ? `<div>Reportable Tax Payout<br><b>${money(totalTaxBase)}</b></div>` : ""}
<div>Expenses<br><b>${money(totalClean)}</b></div>
<div>${mode==="DRAFT"?"Draft From Owner":"Owner Payout"}<br>
<b>${money(mode==="DRAFT"? totalPMC+totalClean : totalAcc-totalPMC)}</b>
</div>
</div>
`;

for(const p in properties){

let rowsHtml="";
let tA=0,tP=0,tC=0,tO=0;

properties[p].forEach(x=>{
rowsHtml+=`
<tr>
<td>${x.id}</td>
<td>${x.platform}</td>
<td>${x.stay}</td>
<td>${money(x.acc)}</td>
<td>${money(x.pmc)}</td>
<td>${money(x.clean)}</td>
<td>${money(x.owner)}</td>
</tr>`;
tA+=x.acc; tP+=x.pmc; tC+=x.clean; tO+=x.owner;
});

html+=`
<div class="property">
<h3>${p}</h3>
<table>
<tr>
<th>Reservation ID</th>
<th>Platform</th>
<th>Stay</th>
<th>Accommodation</th>
<th>PMC</th>
<th>Cleaning</th>
<th>${mode==="DRAFT"?"Draft":"Owner Payout"}</th>
</tr>
${rowsHtml}
<tr class="total">
<td colspan="3">TOTAL</td>
<td>${money(tA)}</td>
<td>${money(tP)}</td>
<td>${money(tC)}</td>
<td>${money(tO)}</td>
</tr>
</table>
</div>`;
}

out.innerHTML=html;
}
</script>

</body>
</html>
