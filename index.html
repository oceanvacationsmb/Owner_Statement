<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff;color:#000}
.topbar{background:#f5f5f5;padding:8px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;border-bottom:1px solid #ccc}
select,input,button{padding:4px;font-size:11px}
button{background:#000;color:#fff;border:none;cursor:pointer}
.content{max-width:900px;margin:auto;padding:20px 0}
.company{font-size:22px;font-weight:900}
.company-info{font-size:11px;line-height:1.4}
.header-row{display:flex;justify-content:space-between}
.statement-dates{text-align:right;font-weight:bold;font-size:12px}
.title{text-align:center;font-size:24px;font-weight:900;margin-top:10px}
.owner{text-align:center;font-size:20px;font-weight:900;margin-top:5px}
.period{text-align:center;font-size:12px;margin-bottom:15px}
.summary-box{border:2px solid #000;padding:10px;margin:15px auto;width:900px}
.summary{display:flex;justify-content:space-between}
.summary-item{text-align:center;flex:1}
.summary-label{font-size:10px;font-weight:bold}
.summary-value{font-size:14px;font-weight:900;margin-top:3px}
.property{margin-top:25px}
.property-header{width:900px;margin:0 auto;font-size:13px;font-weight:bold}
.property-period{font-size:10px}
table{width:900px;margin:5px auto;border-collapse:collapse;font-size:10px}
th,td{border:1px solid #000;padding:4px;text-align:center}
th{background:#000;color:#fff}
tr:nth-child(even){background:#f2f2f2}
.total{font-weight:bold;background:#e5e5e5}
.property-summary{width:900px;margin:5px auto;font-weight:bold;font-size:11px;text-align:left}
.expense-section{width:900px;margin:5px auto}
.expense-table{width:900px;border-collapse:collapse;font-size:10px;margin-top:5px}
.expense-table th{background:#000;color:#fff}
.expense-table input,.expense-table select{font-size:10px;padding:2px}
.add-row input,.add-row select{width:100%}
@media print{
.topbar{display:none}
.expense-section{display:none}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<select id="percent" disabled></select>
<select id="payType" disabled></select>
<input type="file" id="fileInput" accept=".csv">
<button onclick="runStatement()">Run Report</button>
<button onclick="downloadPDF()" id="pdfBtn" disabled>Download PDF</button>
</div>

<div id="output" class="content"></div>

<script>

const owners={
"ERAN MARON":{percent:0.12,type:"draft"},
"GHO":{percent:0.10,type:"payout"},
"1463 Basin Trail":{percent:0.12,type:"payout"},
"113B-15S Surfside Beach":{percent:0.12,type:"payout"},
"113B-13N Surfside Beach":{percent:0.12,type:"payout"},
"115C-15N Surfside Beach":{percent:0.12,type:"payout"},
"2131 Sanibel Myrtle Beach":{percent:0.15,type:"payout"},
"1552 Elizabeth Ln Myrtle Beach":{percent:0.15,type:"payout"},
"469C White River RD Myrtle Beach":{percent:0.12,type:"payout"},
"4631-301 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout"},
"4679-204 Wild Iris Drive Myrtle Beach":{percent:0.12,type:"payout"},
"508-1/2 33rd Ave North Myrtle Beach":{percent:0.15,type:"payout"},
"214-2S 2nd Ave S. North Myrtle Beach":{percent:0.12,type:"payout"}
};

const ownerSelect=document.getElementById("owner");
Object.keys(owners).forEach(o=> ownerSelect.innerHTML+=`<option value="${o}">${o}</option>`);

function applyOwner(){
const o=ownerSelect.value;
document.getElementById("percent").innerHTML=`<option>${owners[o].percent*100}%</option>`;
document.getElementById("payType").innerHTML=`<option>${owners[o].type.toUpperCase()}</option>`;
}
ownerSelect.onchange=applyOwner;
applyOwner();

const monthSelect=document.getElementById("month");
const yearSelect=document.getElementById("year");
const now=new Date();
for(let m=1;m<=12;m++){
let mm=m.toString().padStart(2,"0");
let name=new Date(0,m-1).toLocaleString('default',{month:'long'});
monthSelect.innerHTML+=`<option value="${mm}">${name}</option>`;
}
monthSelect.value=(now.getMonth()+1).toString().padStart(2,"0");

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSelect.innerHTML+=`<option value="${y}">${y}</option>`;
}
yearSelect.value=now.getFullYear();

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0}
function money(x){return "$"+(Number(x)||0).toFixed(2)}
function stay(i,o){if(!i||!o)return"";let a=i.split("-"),b=o.split("-");return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2]}
function lastDay(y,m){return new Date(y,m,0).getDate()}
function normalizePlatform(p){
if(!p) return "";
if(p.toLowerCase().includes("manual")) return "Direct";
if(p.toLowerCase().includes("vrbo")) return "VRBO";
return p;
}

let globalExpenses={};

async function runStatement(){

const file=document.getElementById("fileInput").files[0];
if(!file) return;

const text=await file.text();
const rows=Papa.parse(text,{header:true,skipEmptyLines:true}).data;

const owner=ownerSelect.value;
const percent=owners[owner].percent;
const type=owners[owner].type;
const month=monthSelect.value;
const year=yearSelect.value;
const endDay=lastDay(year,month);

const statementDate=new Date(year,month,1);
const paymentDate=new Date(year,month,5);

let tablesHTML="";
let totalGross=0,totalAcc=0,totalClean=0,totalPMC=0,totalExpense=0,totalDraft=0,totalOwner=0;

const grouped={};

rows.forEach(r=>{
if(!r["CHECK-IN DATE"])return;
if(r["CHECK-IN DATE"].substring(5,7)!==month)return;
if(r["CHECK-IN DATE"].substring(0,4)!==String(year))return;
const listing=r["LISTING'S NICKNAME"]||"Unknown";
if(!grouped[listing])grouped[listing]=[];
grouped[listing].push(r);
});

Object.keys(grouped).forEach(listing=>{

let pGross=0,pAcc=0,pClean=0,pPMC=0,pExpense=0,pDraft=0,pOwner=0;
globalExpenses[listing]=[];

tablesHTML+=`
<div class="property">
<div class="property-header">${listing}
<div class="property-period">${month}/1/${year} - ${month}/${endDay}/${year}</div>
</div>

<table>
<tr>
<th>Reservation</th>
<th>Platform</th>
<th>Stay</th>
<th>Accommodation</th>
<th>PMC</th>
${type==="draft"?"<th>Cleaning</th><th>Draft</th>":"<th>Owner</th>"}
</tr>
`;

grouped[listing].forEach(r=>{
let payout=num(r["TOTAL PAYOUT"]);
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let cleaning=num(r["CLEANING FARE"]);
let pmc=acc*percent;
let draft=pmc+cleaning;
let ownerPay=acc-pmc;

pGross+=payout;
pAcc+=acc;
pClean+=cleaning;
pPMC+=pmc;
pDraft+=draft;
pOwner+=ownerPay;

totalGross+=payout;
totalAcc+=acc;
totalClean+=cleaning;
totalPMC+=pmc;

tablesHTML+=`
<tr>
<td>${r["CONFIRMATION CODE"]}</td>
<td>${normalizePlatform(r["PLATFORM"])}</td>
<td>${stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])}</td>
<td>${money(acc)}</td>
<td>${money(pmc)}</td>
${type==="draft"
?`<td>${money(cleaning)}</td><td>${money(draft)}</td>`
:`<td>${money(ownerPay)}</td>`}
</tr>`;
});

tablesHTML+=`
<tr class="total">
<td>TOTAL</td><td></td><td></td>
<td>${money(pAcc)}</td>
<td>${money(pPMC)}</td>
${type==="draft"
?`<td>${money(pClean)}</td><td>${money(pDraft)}</td>`
:`<td>${money(pOwner)}</td>`}
</tr>
</table>

<div class="property-summary" id="summary-${listing}">
${type==="draft"
?`Total Property Payout: ${money(pGross)} | Total PMC: ${money(pPMC)} | Total Cleaning: ${money(pClean)} | Total Expenses: $0.00 | Balance Due: ${money(pDraft)}`
:`Total PMC: ${money(pPMC)} | Total Expenses: $0.00 | Owner Balance: ${money(pOwner)}`}
</div>

<div class="expense-section">
<table class="expense-table" id="expense-${listing}">
<tr><th>Type</th><th>Description</th><th>Amount</th><th>Action</th></tr>
<tr class="add-row">
<td>
<select id="type-${listing}">
<option>Maintenance</option>
<option>Repair</option>
<option>Pool Cleaning</option>
<option>Pest Control</option>
<option>Purchase</option>
</select>
</td>
<td><input id="desc-${listing}" type="text"></td>
<td><input id="amt-${listing}" type="number" step="0.01"></td>
<td><button onclick="addExpense('${listing}',${pPMC},${pClean},${pDraft},${pOwner})">Add</button></td>
</tr>
</table>
</div>

</div>
`;
});

document.getElementById("output").innerHTML=`
<div id="statement">
<div class="header-row">
<div>
<div class="company">OCEAN VACATIONS</div>
<div class="company-info">
www.oceanvacationsmb.com<br>
oceanvacationsmb@gmail.com<br>
843-222-6516
</div>
</div>
<div class="statement-dates">
Statement Date: ${statementDate.toLocaleDateString()}<br>
Payment Date: ${paymentDate.toLocaleDateString()}
</div>
</div>
<div class="title">RESERVATION REPORT</div>
<div class="owner">${owner}</div>
<div class="period">${new Date(year,month-1).toLocaleString('default',{month:'long'})} 1 - ${endDay}, ${year}</div>
${tablesHTML}
</div>
`;

document.getElementById("pdfBtn").disabled=false;
}

function addExpense(listing,pPMC,pClean,pDraft,pOwner){

const type=document.getElementById(`type-${listing}`).value;
const desc=document.getElementById(`desc-${listing}`).value;
const amt=parseFloat(document.getElementById(`amt-${listing}`).value)||0;
if(!amt) return;

globalExpenses[listing].push({type,desc,amt});

const table=document.getElementById(`expense-${listing}`);
const row=table.insertRow(table.rows.length-1);
row.innerHTML=`<td>${type}</td><td>${desc}</td><td>${money(amt)}</td><td><button onclick="this.parentElement.parentElement.remove()">Delete</button></td>`;

let totalExp=globalExpenses[listing].reduce((a,b)=>a+b.amt,0);
document.getElementById(`summary-${listing}`).innerHTML=
`Total PMC: ${money(pPMC)} | Total Expenses: ${money(totalExp)}`;

document.getElementById(`desc-${listing}`).value="";
document.getElementById(`amt-${listing}`).value="";
}

function downloadPDF(){
html2pdf().set({margin:5,jsPDF:{unit:"mm",format:"a4"}})
.from(document.getElementById("statement")).save("Reservation_Report.pdf");
}
</script>

</body>
</html>
