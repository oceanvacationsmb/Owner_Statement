<!DOCTYPE html>
<html>
<head>
<title>PMC Owner Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial; padding:40px; background:#f2f4f7; }
input { padding:10px; margin:10px 0; width:300px; }
button { padding:10px 20px; background:#2c7be5; color:white; border:none; }
table { width:100%; border-collapse:collapse; margin-top:30px; background:white; font-size:13px; }
th,td { border:1px solid #ddd; padding:6px; text-align:right; }
th { background:#f0f0f0; }
td.left { text-align:left; }
.section { background:white; padding:20px; margin-top:30px; }
</style>
</head>

<body>

<h2>PMC Hold Payout Report</h2>

<input type="file" id="csvFile" accept=".csv"><br>
<label>Management %</label><br>
<input type="number" id="percent" value="12"><br>
<button onclick="run()">Calculate</button>

<div id="summary" class="section"></div>
<div id="taxes" class="section"></div>
<div id="pmc" class="section"></div>
<div id="table"></div>

<script>

function n(v){ return parseFloat((v||"0").toString().replace(/[$,]/g,''))||0; }

function formatStay(inDate,outDate){
 if(!inDate && !outDate) return "";
 let i = inDate ? inDate.split("-") : [];
 let o = outDate ? outDate.split("-") : [];
 if(i.length===3 && o.length===3){
   return i[1]+"/"+i[2]+" - "+o[1]+"/"+o[2];
 }
 return "";
}

function run(){

let file = document.getElementById("csvFile").files[0];
let percent = parseFloat(document.getElementById("percent").value)/100;

if(!file){ alert("Upload CSV"); return; }

Papa.parse(file,{
header:true,
skipEmptyLines:true,
complete:function(res){

let data = res.data;

let totalTrue=0;
let totalMgmt=0;
let totalCleaning=0;
let totalPayout=0;

let totalCity=0;
let totalState=0;
let totalCounty=0;
let totalOcc=0;

let showStay=false;
let showCity=false;
let showState=false;
let showCounty=false;
let showOcc=false;

data.forEach(r=>{
 if(r["CHECK-IN DATE"]||r["CHECK-OUT DATE"]) showStay=true;
 if(n(r["CITY TAX"])>0) showCity=true;
 if(n(r["STATE TAX"])>0) showState=true;
 if(n(r["COUNTY TAX"])>0) showCounty=true;
 if(n(r["OCCUPANCY TAX"])>0) showOcc=true;
});

let html="<table><tr>";
html+="<th>Listing</th>";
html+="<th>Confirmation</th>";
html+="<th>Platform</th>";
if(showStay) html+="<th>Stay</th>";
html+="<th>Accommodation</th>";
html+="<th>Markup</th>";
html+="<th>True Accommodation</th>";
html+="<th>Cleaning</th>";
if(showCity) html+="<th>City Tax</th>";
if(showState) html+="<th>State Tax</th>";
if(showCounty) html+="<th>County Tax</th>";
if(showOcc) html+="<th>Occupancy Tax</th>";
html+="</tr>";

data.forEach(r=>{

if(n(r["CANCELED TOTAL PAYOUT"])!==0) return;

let acc=n(r["ACCOMMODATION FARE"]);
let adj=n(r["ACCOMMODATION FARE ADJUSTMENT"]);
let markup=n(r["MARKUP"]);
let cleaning=n(r["CLEANING FARE"]);
let payout=n(r["TOTAL PAYOUT"]);

let city=n(r["CITY TAX"]);
let state=n(r["STATE TAX"]);
let county=n(r["COUNTY TAX"]);
let occ=n(r["OCCUPANCY TAX"]);

let trueAcc=(acc+adj)-markup;
let mgmt=trueAcc*percent;

totalTrue+=trueAcc;
totalMgmt+=mgmt;
totalCleaning+=cleaning;
totalPayout+=payout;

totalCity+=city;
totalState+=state;
totalCounty+=county;
totalOcc+=occ;

html+="<tr>";
html+="<td class='left'>"+(r["LISTING'S NICKNAME"]||"")+"</td>";
html+="<td class='left'>"+(r["CONFIRMATION CODE"]||"")+"</td>";
html+="<td class='left'>"+(r["PLATFORM"]||"")+"</td>";
if(showStay) html+="<td>"+formatStay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])+"</td>";
html+="<td>$"+acc.toFixed(2)+"</td>";
html+="<td>$"+markup.toFixed(2)+"</td>";
html+="<td>$"+trueAcc.toFixed(2)+"</td>";
html+="<td>$"+cleaning.toFixed(2)+"</td>";
if(showCity) html+="<td>$"+city.toFixed(2)+"</td>";
if(showState) html+="<td>$"+state.toFixed(2)+"</td>";
if(showCounty) html+="<td>$"+county.toFixed(2)+"</td>";
if(showOcc) html+="<td>$"+occ.toFixed(2)+"</td>";
html+="</tr>";

});

html+="</table>";

document.getElementById("summary").innerHTML=
"<h3>Summary</h3>"+
"Total True Accommodation: $"+totalTrue.toFixed(2)+"<br>"+
"<strong>Amount To Pay Owner: $"+(totalPayout-totalMgmt-totalCleaning).toFixed(2)+"</strong>";

document.getElementById("taxes").innerHTML=
"<h3>Taxes</h3>"+
(showCity?"City Tax: $"+totalCity.toFixed(2)+"<br>":"")+
(showState?"State Tax: $"+totalState.toFixed(2)+"<br>":"")+
(showCounty?"County Tax: $"+totalCounty.toFixed(2)+"<br>":"")+
(showOcc?"Occupancy Tax: $"+totalOcc.toFixed(2):"");

document.getElementById("pmc").innerHTML=
"<h3>PMC Transfer</h3>"+
"Total Management Commission: $"+totalMgmt.toFixed(2)+"<br>"+
"Total Amount To Report Taxes (Total Payout): $"+totalPayout.toFixed(2);

document.getElementById("table").innerHTML=html;

}
});

}
</script>

</body>
</html>
