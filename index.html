function processCSV() {

    const file = document.getElementById('csvFile').files[0];
    const percent = parseFloat(document.getElementById('percent').value) / 100;
    const ownerType = document.getElementById('ownerType').value;

    if (!file) {
        alert("Upload CSV first");
        return;
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {

            const data = results.data;
            const headers = results.meta.fields;

            // Detect columns that actually contain data
            let activeColumns = headers.filter(col =>
                data.some(row => row[col] && row[col].toString().trim() !== "")
            );

            let totalBase = 0;
            let totalManagement = 0;
            let totalCleaning = 0;
            let totalPayout = 0;
            let totalMarkup = 0;

            let tableHTML = "<table><tr>";

            activeColumns.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });

            tableHTML += `
                <th>TRUE BASE</th>
                <th>MANAGEMENT</th>
            </tr>
            `;

            data.forEach(row => {

                const acc = cleanNumber(row["ACCOMMODATION FARE"]);
                const markup = cleanNumber(row["MARKUP"]);
                const cleaning = cleanNumber(row["CLEANING FARE"]);
                const payout = cleanNumber(row["TOTAL PAYOUT"]);
                const adjustment = cleanNumber(row["ACCOMMODATION FARE ADJUSTMENT"]);

                const trueBase = (acc + adjustment) - markup;
                const management = trueBase * percent;

                totalBase += trueBase;
                totalManagement += management;
                totalCleaning += cleaning;
                totalPayout += payout;
                totalMarkup += markup;

                tableHTML += "<tr>";

                activeColumns.forEach(col => {
                    tableHTML += `<td>${row[col] || ""}</td>`;
                });

                tableHTML += `
                    <td>$${trueBase.toFixed(2)}</td>
                    <td>$${management.toFixed(2)}</td>
                </tr>
                `;
            });

            tableHTML += "</table>";

            let summaryHTML = `
                <h3>Summary</h3>
                Total True Accommodation: $${totalBase.toFixed(2)}<br>
                Total Management: $${totalManagement.toFixed(2)}<br>
                Total Cleaning: $${totalCleaning.toFixed(2)}<br>
                Total Markup: $${totalMarkup.toFixed(2)}<br><br>
            `;

            if (ownerType === "direct") {
                summaryHTML += `<strong>Amount To Draft From Owner: $${(totalManagement + totalCleaning).toFixed(2)}</strong>`;
            } else {
                summaryHTML += `<strong>Amount To Pay Owner: ${(totalPayout - totalManagement - totalCleaning).toFixed(2)}</strong>`;
            }

            document.getElementById("summary").innerHTML = summaryHTML;
            document.getElementById("tableContainer").innerHTML = tableHTML;
        }
    });
}
