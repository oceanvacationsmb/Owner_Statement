<!DOCTYPE html>
<html>
<head>
<title>PMC Owner Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial; padding:40px; background:#f2f4f7; }
input,select { padding:10px; margin:10px 0; width:300px; }
button { padding:10px 20px; background:#2c7be5; color:white; border:none; }
table { width:100%; border-collapse:collapse; margin-top:30px; background:white; font-size:13px; }
th,td { border:1px solid #ddd; padding:6px; text-align:right; }
th { background:#f0f0f0; }
td.left { text-align:left; }
tfoot td { font-weight:bold; background:#fafafa; }
.section { background:white; padding:20px; margin-top:30px; }
</style>
</head>

<body>

<h2>Owner Statement Calculator</h2>

<input type="file" id="csvFile" accept=".csv"><br>

<label>Management %</label><br>
<input type="number" id="percent" value="12"><br>

<label>Owner Type</label><br>
<select id="ownerType">
<option value="pmc">PMC Holds Payout</option>
<option value="direct">Owner Gets Paid Directly</option>
</select><br>

<button onclick="run()">Calculate</button>

<div id="summary" class="section"></div>
<div id="taxes" class="section"></div>
<div id="pmc" class="section"></div>
<div id="table"></div>

<script>

function n(v){ return parseFloat((v||"0").toString().replace(/[$,]/g,''))||0; }

function stay(i,o){
 if(!i && !o) return "";
 let a=i?i.split("-"):[], b=o?o.split("-"):[];
 if(a.length===3 && b.length===3) return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2];
 return "";
}

function run(){

let file=document.getElementById("csvFile").files[0];
let percent=parseFloat(document.getElementById("percent").value)/100;
let ownerType=document.getElementById("ownerType").value;

if(!file){ alert("Upload CSV"); return; }

Papa.parse(file,{
header:true,
skipEmptyLines:true,
complete:function(res){

let d=res.data;

let totalAcc=0,totalMarkup=0,totalTrue=0,totalCleaning=0,totalMgmt=0,totalPayout=0;
let totalCity=0,totalState=0,totalCounty=0,totalOcc=0;

let showStay=false,showCity=false,showState=false,showCounty=false,showOcc=false;

d.forEach(r=>{
 if(r["CHECK-IN DATE"]||r["CHECK-OUT DATE"]) showStay=true;
 if(n(r["CITY TAX"])>0) showCity=true;
 if(n(r["STATE TAX"])>0) showState=true;
 if(n(r["COUNTY TAX"])>0) showCounty=true;
 if(n(r["OCCUPANCY TAX"])>0) showOcc=true;
});

let html="<table><thead><tr>";
html+="<th>Listing</th>";
html+="<th>Confirmation</th>";
html+="<th>Platform</th>";
if(showStay) html+="<th>Stay</th>";
html+="<th>Accommodation</th>";
html+="<th>Markup</th>";
html+="<th>True Accommodation</th>";
html+="<th>Cleaning</th>";
if(showCity) html+="<th>City Tax</th>";
if(showState) html+="<th>State Tax</th>";
if(showCounty) html+="<th>County Tax</th>";
if(showOcc) html+="<th>Occupancy Tax</th>";
html+="</tr></thead><tbody>";

d.forEach(r=>{

if(n(r["CANCELED TOTAL PAYOUT"])!==0) return;

let acc=n(r["ACCOMMODATION FARE"]);
let adj=n(r["ACCOMMODATION FARE ADJUSTMENT"]);
let markup=n(r["MARKUP"]);
let cleaning=n(r["CLEANING FARE"]);
let payout=n(r["TOTAL PAYOUT"]);
let city=n(r["CITY TAX"]);
let state=n(r["STATE TAX"]);
let county=n(r["COUNTY TAX"]);
let occ=n(r["OCCUPANCY TAX"]);

let trueAcc=(acc+adj)-markup;
let mgmt=trueAcc*percent;

totalAcc+=acc;
totalMarkup+=markup;
totalTrue+=trueAcc;
totalCleaning+=cleaning;
totalMgmt+=mgmt;
totalPayout+=payout;
totalCity+=city;
totalState+=state;
totalCounty+=county;
totalOcc+=occ;

html+="<tr>";
html+="<td class='left'>"+(r["LISTING'S NICKNAME"]||"")+"</td>";
html+="<td class='left'>"+(r["CONFIRMATION CODE"]||"")+"</td>";
html+="<td class='left'>"+(r["PLATFORM"]||"")+"</td>";
if(showStay) html+="<td>"+stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])+"</td>";
html+="<td>$"+acc.toFixed(2)+"</td>";
html+="<td>$"+markup.toFixed(2)+"</td>";
html+="<td>$"+trueAcc.toFixed(2)+"</td>";
html+="<td>$"+cleaning.toFixed(2)+"</td>";
if(showCity) html+="<td>$"+city.toFixed(2)+"</td>";
if(showState) html+="<td>$"+state.toFixed(2)+"</td>";
if(showCounty) html+="<td>$"+county.toFixed(2)+"</td>";
if(showOcc) html+="<td>$"+occ.toFixed(2)+"</td>";
html+="</tr>";

});

html+="</tbody><tfoot><tr>";
html+="<td colspan='"+(showStay?4:3)+"' class='left'>TOTAL</td>";
html+="<td>$"+totalAcc.toFixed(2)+"</td>";
html+="<td>$"+totalMarkup.toFixed(2)+"</td>";
html+="<td>$"+totalTrue.toFixed(2)+"</td>";
html+="<td>$"+totalCleaning.toFixed(2)+"</td>";
if(showCity) html+="<td>$"+totalCity.toFixed(2)+"</td>";
if(showState) html+="<td>$"+totalState.toFixed(2)+"</td>";
if(showCounty) html+="<td>$"+totalCounty.toFixed(2)+"</td>";
if(showOcc) html+="<td>$"+totalOcc.toFixed(2)+"</td>";
html+="</tr></tfoot></table>";

document.getElementById("table").innerHTML=html;

let amountOwner=0;
if(ownerType==="pmc"){
 amountOwner=totalPayout-totalMgmt-totalCleaning;
}else{
 amountOwner=totalMgmt+totalCleaning;
}

document.getElementById("summary").innerHTML=
"<h3>Summary</h3>"+
"Total True Accommodation: $"+totalTrue.toFixed(2)+"<br>"+
"<strong>"+(ownerType==="pmc"?"Amount To Pay Owner: $":"Amount To Draft From Owner: $")+amountOwner.toFixed(2)+"</strong>";

document.getElementById("taxes").innerHTML=
"<h3>Taxes</h3>"+
(showCity?"City Tax: $"+totalCity.toFixed(2)+"<br>":"")+
(showState?"State Tax: $"+totalState.toFixed(2)+"<br>":"")+
(showCounty?"County Tax: $"+totalCounty.toFixed(2)+"<br>":"")+
(showOcc?"Occupancy Tax: $"+totalOcc.toFixed(2):"");

document.getElementById("pmc").innerHTML=
"<h3>PMC Transfer</h3>"+
"Total Management Commission: $"+totalMgmt.toFixed(2)+"<br>"+
"Total Amount To Report Taxes (Total Payout): $"+totalPayout.toFixed(2);

}
});

}
</script>

</body>
</html>
