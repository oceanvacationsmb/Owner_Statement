<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff;color:#000}
.topbar{background:#f2f2f2;padding:10px;display:flex;gap:10px;flex-wrap:wrap;border-bottom:2px solid #000}
button{padding:8px 16px;font-weight:bold;border:none;cursor:pointer}
.run-btn{background:#000;color:#fff}
.pdf-btn{background:#444;color:#fff}
.finish-btn{background:#888;color:#fff;margin-top:5px}
.content{max-width:900px;margin:auto;padding:20px}
.page-break{page-break-after:always}
.header{display:flex;justify-content:space-between}
.company{font-size:22px;font-weight:900}
.company-info{font-size:11px}
.title{text-align:center;font-size:24px;font-weight:900;margin-top:10px}
.owner{text-align:center;font-size:18px;font-weight:bold;margin-top:5px}
.period{text-align:center;font-size:12px;margin-bottom:15px}
.section-title{font-size:18px;font-weight:bold;margin-top:10px}
.summary-box{border:2px solid #000;padding:10px;margin:15px 0}
.summary{display:flex;justify-content:space-between;font-size:12px}
.summary div{text-align:center;flex:1}
.summary strong{display:block;font-size:14px;margin-top:4px}
.property{margin-top:30px}
.property-title{font-size:16px;font-weight:bold}
table{width:100%;border-collapse:collapse;font-size:10px;margin-top:10px}
th,td{border:1px solid #000;padding:4px;text-align:center}
th{background:#000;color:#fff}
.total-row{font-weight:bold;background:#e5e5e5}
.expense-table input,.expense-table select{width:100%;font-size:10px}
.attachment{margin-top:10px}
@media print{
.topbar,.finish-btn,.add-row button{display:none}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<input type="file" id="fileInput" accept=".csv">
<button class="run-btn" onclick="runReport()">Run Statement</button>
<button class="pdf-btn" onclick="downloadPDF()">Download PDF</button>
</div>

<div id="report" class="content"></div>

<script>

const owners={
"ERAN MARON":{percent:0.12,type:"draft"},
"GHO":{percent:0.10,type:"payout"}
};

const ownerSelect=document.getElementById("owner");
Object.keys(owners).forEach(o=>ownerSelect.innerHTML+=`<option>${o}</option>`);

const monthSelect=document.getElementById("month");
const yearSelect=document.getElementById("year");
const now=new Date();

for(let m=1;m<=12;m++){
monthSelect.innerHTML+=`<option value="${m}">${new Date(0,m-1).toLocaleString('default',{month:'long'})}</option>`;
}
monthSelect.value=now.getMonth()+1;

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSelect.innerHTML+=`<option>${y}</option>`;
}
yearSelect.value=now.getFullYear();

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0}
function money(x){return "$"+(Number(x)||0).toFixed(2)}
function stay(i,o){if(!i||!o)return"";let a=i.split("-"),b=o.split("-");return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2]}
function lastDay(y,m){return new Date(y,m,0).getDate()}

let propertyTotals={};
let masterTotals={};

async function runReport(){

propertyTotals={};
masterTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0};

const file=document.getElementById("fileInput").files[0];
if(!file)return;

const text=await file.text();
const rows=Papa.parse(text,{header:true,skipEmptyLines:true}).data;

const owner=ownerSelect.value;
const percent=owners[owner].percent;
const type=owners[owner].type;
const month=parseInt(monthSelect.value);
const year=parseInt(yearSelect.value);
const endDay=lastDay(year,month);

const statementDate=new Date(year,month,1);
const paymentDate=new Date(year,month,5);

let grouped={};

rows.forEach(r=>{
if(!r["CHECK-IN DATE"])return;
let m=parseInt(r["CHECK-IN DATE"].split("-")[1]);
let y=parseInt(r["CHECK-IN DATE"].split("-")[0]);
if(m!==month||y!==year)return;

let listing=r["LISTING'S NICKNAME"]||"Unknown";
if(!grouped[listing])grouped[listing]=[];
grouped[listing].push(r);
});

let reportHTML="";

/* HEADER */
reportHTML+=`
<div class="header">
<div>
<div class="company">OCEAN VACATIONS</div>
<div class="company-info">
www.oceanvacationsmb.com<br>
oceanvacationsmb@gmail.com<br>
843-222-6516
</div>
</div>
<div>
Statement Date: ${statementDate.toLocaleDateString()}<br>
Payment Date: ${paymentDate.toLocaleDateString()}
</div>
</div>

<div class="title">RESERVATION REPORT</div>
<div class="owner">${owner}</div>
<div class="period">${month}/1/${year} - ${month}/${endDay}/${year}</div>
`;

Object.keys(grouped).forEach(listing=>{

let pGross=0,pAcc=0,pClean=0,pPMC=0,pDraft=0,pOwner=0;

grouped[listing].forEach(r=>{
let payout=num(r["TOTAL PAYOUT"]);
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let clean=num(r["CLEANING FARE"]);
let pmc=acc*percent;
let draft=pmc+clean;
let ownerPay=acc-pmc;

pGross+=payout;
pAcc+=acc;
pClean+=clean;
pPMC+=pmc;
pDraft+=draft;
pOwner+=ownerPay;
});

propertyTotals[listing]={gross:pGross,acc:pAcc,clean:pClean,pmc:pPMC,draft:pDraft,owner:pOwner,expenses:0};

masterTotals.gross+=pGross;
masterTotals.acc+=pAcc;
masterTotals.clean+=pClean;
masterTotals.pmc+=pPMC;
masterTotals.draft+=pDraft;
masterTotals.owner+=pOwner;
});

/* MASTER SUMMARY PAGE */

reportHTML+=`
<div class="section-title">SUMMARY</div>
<div class="summary-box">
<div class="summary">
${type==="draft"
?`
<div>Gross<strong>${money(masterTotals.gross)}</strong></div>
<div>Accommodation<strong>${money(masterTotals.acc)}</strong></div>
<div>Cleaning<strong>${money(masterTotals.clean)}</strong></div>
<div>Expenses<strong id="masterExp">$0.00</strong></div>
<div>Draft<strong id="masterBal">${money(masterTotals.draft)}</strong></div>
`
:`
<div>Accommodation<strong>${money(masterTotals.acc)}</strong></div>
<div>PMC<strong>${money(masterTotals.pmc)}</strong></div>
<div>Expenses<strong id="masterExp">$0.00</strong></div>
<div>Due<strong id="masterBal">${money(masterTotals.owner)}</strong></div>
`}
</div>
</div>

<div class="page-break"></div>
`;

/* PROPERTY PAGES */

Object.keys(grouped).forEach(listing=>{

let p=propertyTotals[listing];

reportHTML+=`
<div class="property">
<div class="property-title">${listing}</div>
<div class="period">${month}/1/${year} - ${month}/${endDay}/${year}</div>

<div class="summary-box">
<div class="summary">
${type==="draft"
?`
<div>Total Property Payout<strong>${money(p.gross)}</strong></div>
<div>Total PMC<strong>${money(p.pmc)}</strong></div>
<div>Total Cleaning<strong>${money(p.clean)}</strong></div>
<div>Total Expenses<strong id="exp-${listing}">$0.00</strong></div>
<div>Balance Due<strong id="bal-${listing}">${money(p.draft)}</strong></div>
`
:`
<div>Total PMC<strong>${money(p.pmc)}</strong></div>
<div>Total Expenses<strong id="exp-${listing}">$0.00</strong></div>
<div>Due to Owner<strong id="bal-${listing}">${money(p.owner)}</strong></div>
`}
</div>
</div>

<table>
<tr>
<th>Reservation</th>
<th>Stay</th>
<th>Accommodation</th>
<th>PMC</th>
${type==="draft"?"<th>Cleaning</th><th>Draft</th>":"<th>Owner</th>"}
</tr>
`;

grouped[listing].forEach(r=>{
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let clean=num(r["CLEANING FARE"]);
let pmc=acc*percent;
let draft=pmc+clean;
let ownerPay=acc-pmc;

reportHTML+=`
<tr>
<td>${r["CONFIRMATION CODE"]}</td>
<td>${stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])}</td>
<td>${money(acc)}</td>
<td>${money(pmc)}</td>
${type==="draft"
?`<td>${money(clean)}</td><td>${money(draft)}</td>`
:`<td>${money(ownerPay)}</td>`}
</tr>
`;
});

reportHTML+=`
</table>

<table class="expense-table" id="expense-${listing}">
<tr>
<th>Type</th>
<th>Description</th>
<th>Amount</th>
</tr>
<tr class="add-row">
<td>
<select>
<option>Maintenance</option>
<option>Repair</option>
<option>Pool Cleaning</option>
<option>Pest Control</option>
<option>Purchase</option>
<option>Cleaning</option>
<option>Service</option>
</select>
</td>
<td><input type="text"></td>
<td><input type="number" step="0.01"></td>
</tr>
</table>

<input type="file" accept=".pdf,.jpg,.jpeg,.png" onchange="attachFile(event,'${listing}')">

<div id="attachment-${listing}" class="attachment"></div>

<button class="finish-btn" onclick="finishExpenses('${listing}',this)">Finish Expenses</button>

</div>

<div class="page-break"></div>
`;
});

document.getElementById("report").innerHTML=reportHTML;
}

/* EXPENSE LOGIC */
function finishExpenses(listing,btn){
let table=document.getElementById(`expense-${listing}`);
table.querySelector(".add-row").remove();
btn.remove();
}

/* ATTACH FILE */
function attachFile(event,listing){
let file=event.target.files[0];
if(!file)return;

let reader=new FileReader();
reader.onload=function(e){
let container=document.getElementById(`attachment-${listing}`);
container.innerHTML=`<embed src="${e.target.result}" width="100%" height="600px">`;
}
reader.readAsDataURL(file);
}

function downloadPDF(){
html2pdf().set({margin:5,jsPDF:{unit:"mm",format:"a4"}})
.from(document.getElementById("report")).save("Reservation_Report.pdf");
}

</script>

</body>
</html>
