<!DOCTYPE html>
<html>
<head>
<title>Owner Statement</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { background:#0f172a; color:#e5e7eb; font-family:Arial; padding:40px; }
h1 { text-align:center; font-size:40px; }

.owner { text-align:center; font-size:34px; color:#facc15; margin-top:10px; }
.period { text-align:center; font-size:20px; color:#9ca3af; margin-bottom:25px; }

.summary { display:flex; justify-content:space-between; margin-bottom:35px; }
.summary div { text-align:center; flex:1; }
.summary span { display:block; font-size:22px; margin-top:6px; }

.property-title { font-size:20px; margin-top:40px; }

table { width:100%; border-collapse:collapse; margin-top:15px; background:#111827; }
th, td { padding:10px; border:1px solid #1f2937; }
th { background:#1f2937; text-align:center; }
td { text-align:right; }
td.left { text-align:left; }

.total-row { background:#1f2937; font-weight:bold; }

button { padding:8px 15px; background:#2563eb; border:none; color:white; cursor:pointer; margin-top:10px; }
select, input { padding:6px; margin:5px; }
</style>
</head>

<body>

<h1>OWNER STATEMENT</h1>

<label>Owner Name:</label>
<input type="text" id="ownerName" value="ERAN"><br>

<label>Month:</label>
<select id="month">
<option value="01">January</option>
<option value="02">February</option>
<option value="03">March</option>
<option value="04">April</option>
<option value="05">May</option>
<option value="06">June</option>
<option value="07">July</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>

<label>Year:</label>
<input type="number" id="year" value="2026"><br>

<label>Management %</label>
<input type="number" id="percent" value="12">

<select id="ownerType">
<option value="pmc">PMC Holds Payout</option>
<option value="direct">Owner Paid Directly</option>
</select>

<br><br>
<input type="file" id="csvFile" accept=".csv">
<button onclick="generate()">Create Statement</button>

<div id="output"></div>

<script>

function num(v){
 return parseFloat((v||"0").toString().replace(/[$,]/g,''))||0;
}

function stay(i,o){
 if(!i||!o) return "";
 let a=i.split("-");
 let b=o.split("-");
 return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2];
}

function lastDay(year,month){
 return new Date(year, month, 0).getDate();
}

function generate(){

let file=document.getElementById("csvFile").files[0];
if(!file){ alert("Upload CSV first"); return; }

let month=document.getElementById("month").value;
let year=document.getElementById("year").value;
let percent=parseFloat(document.getElementById("percent").value)/100;
let ownerType=document.getElementById("ownerType").value;
let owner=document.getElementById("ownerName").value;

let endDay=lastDay(year,month);

Papa.parse(file,{
header:true,
skipEmptyLines:true,
complete:function(result){

let rows=result.data;
let grouped={};

let totalTrueAccommodation=0;
let totalMgmt=0;
let totalOwnerPayout=0;

rows.forEach(function(r){

if(num(r["CANCELED TOTAL PAYOUT"])!==0) return;
if(!r["CHECK-IN DATE"]) return;

let checkMonth=r["CHECK-IN DATE"].substring(5,7);
let checkYear=r["CHECK-IN DATE"].substring(0,4);

if(checkMonth!==month || checkYear!==year.toString()) return;

let listing=r["LISTING'S NICKNAME"]||"Unknown";

if(!grouped[listing]) grouped[listing]=[];
grouped[listing].push(r);

});

let html="";
html+="<div class='owner'>"+owner+"</div>";
html+="<div class='period'>"+
new Date(year,month-1).toLocaleString('default',{month:'short'})+
" 1 - "+
new Date(year,month-1).toLocaleString('default',{month:'short'})+
" "+endDay+" "+year+
"</div>";

Object.keys(grouped).forEach(function(listing){

let propertyTrueAccommodation=0;
let propertyMgmt=0;
let propertyOwnerPayout=0;

html+="<div class='property-title'>üè† "+listing+"</div>";
html+="<table>";
html+="<tr>";
html+="<th>Reservation ID</th>";
html+="<th>Platform</th>";
html+="<th>Stay</th>";
html+="<th>True Accommodation</th>";
html+="<th>PMC</th>";
if(ownerType==="pmc") html+="<th>Owner Payout</th>";
html+="</tr>";

grouped[listing].forEach(function(r){

let acc=num(r["ACCOMMODATION FARE"]);
let markup=num(r["MARKUP"]);

let trueAccommodation=acc-markup;   // FIXED FORMULA
let mgmt=trueAccommodation*percent;
let ownerPayout=trueAccommodation-mgmt;

propertyTrueAccommodation+=trueAccommodation;
propertyMgmt+=mgmt;
propertyOwnerPayout+=ownerPayout;

totalTrueAccommodation+=trueAccommodation;
totalMgmt+=mgmt;

if(ownerType==="pmc"){
 totalOwnerPayout+=ownerPayout;
}

html+="<tr>";
html+="<td class='left'>"+(r["CONFIRMATION CODE"]||"")+"</td>";
html+="<td class='left'>"+(r["PLATFORM"]||"")+"</td>";
html+="<td>"+stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])+"</td>";
html+="<td>$"+trueAccommodation.toFixed(2)+"</td>";
html+="<td>$"+mgmt.toFixed(2)+"</td>";
if(ownerType==="pmc") html+="<td>$"+ownerPayout.toFixed(2)+"</td>";
html+="</tr>";

});

html+="<tr class='total-row'>";
html+="<td class='left'>TOTAL</td>";
html+="<td></td><td></td>";
html+="<td>$"+propertyTrueAccommodation.toFixed(2)+"</td>";
html+="<td>$"+propertyMgmt.toFixed(2)+"</td>";
if(ownerType==="pmc") html+="<td>$"+propertyOwnerPayout.toFixed(2)+"</td>";
html+="</tr>";

html+="</table>";

});

html =
"<div class='owner'>"+owner+"</div>"+
"<div class='period'>"+
new Date(year,month-1).toLocaleString('default',{month:'short'})+
" 1 - "+
new Date(year,month-1).toLocaleString('default',{month:'short'})+
" "+endDay+" "+year+
"</div>"+
"<div class='summary'>"+
"<div>TRUE ACCOMMODATION<span>$"+totalTrueAccommodation.toFixed(2)+"</span></div>"+
"<div>PMC COMMISSION<span>$"+totalMgmt.toFixed(2)+"</span></div>"+
(ownerType==="pmc"
 ? "<div>OWNER PAYOUT<span>$"+totalOwnerPayout.toFixed(2)+"</span></div>"
 : "<div>DRAFT FROM OWNER<span>$"+totalMgmt.toFixed(2)+"</span></div>")+
"</div>"+html;

document.getElementById("output").innerHTML=html;

}
});

}

</script>

</body>
</html>
