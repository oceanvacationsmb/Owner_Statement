<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff;color:#000}
.topbar{background:#f2f2f2;padding:6px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;border-bottom:1px solid #ccc}
select,input,button{padding:3px;font-size:11px}
button{background:#000;color:#fff;border:none;cursor:pointer}
.content{max-width:820px;margin:auto;padding:20px}
.company{font-size:20px;font-weight:900}
.company-info{font-size:10px}
.header{display:flex;justify-content:space-between}
.dates{font-size:11px;font-weight:bold;text-align:right}
.title{text-align:center;font-size:22px;font-weight:900;margin-top:10px}
.owner{text-align:center;font-size:18px;font-weight:900;margin-top:5px}
.period{text-align:center;font-size:11px;margin-bottom:10px}

.summary-box{
border:2px solid #000;
padding:10px;
margin:15px 0;
}

.summary{
display:flex;
justify-content:space-between;
font-size:11px;
}

.summary div{
text-align:center;
flex:1;
}

.summary strong{
display:block;
font-size:13px;
margin-top:3px;
}

.property{margin-top:20px}
.property-title{font-size:12px;font-weight:bold}
.property-period{font-size:10px;margin-bottom:4px}

table{
width:100%;
border-collapse:collapse;
font-size:9px;
margin-bottom:5px;
}

th,td{
border:1px solid #000;
padding:3px;
text-align:center;
}

th{
background:#000;
color:#fff;
}

tr:nth-child(even){background:#f5f5f5}

.total-row{font-weight:bold;background:#e5e5e5}

.property-summary{
font-size:10px;
font-weight:bold;
margin-bottom:8px;
}

.expense-table{
width:100%;
border-collapse:collapse;
font-size:9px;
margin-top:5px;
}

.expense-table th{background:#000;color:#fff}

.expense-table input,.expense-table select{
font-size:9px;
padding:2px;
width:100%;
box-sizing:border-box;
}

.expense-controls button{
font-size:8px;
padding:2px 4px;
}

@media print{
.topbar{display:none}
.expense-table{display:none}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<input type="file" id="fileInput" accept=".csv">
<button onclick="runReport()">Run</button>
<button onclick="downloadPDF()" id="pdfBtn" disabled>PDF</button>
</div>

<div id="output" class="content"></div>

<script>

const owners={
"ERAN MARON":{percent:0.12,type:"draft"},
"GHO":{percent:0.10,type:"payout"}
};

const ownerSelect=document.getElementById("owner");
Object.keys(owners).forEach(o=>ownerSelect.innerHTML+=`<option>${o}</option>`);

const monthSelect=document.getElementById("month");
const yearSelect=document.getElementById("year");

const now=new Date();

for(let m=1;m<=12;m++){
let name=new Date(0,m-1).toLocaleString('default',{month:'long'});
monthSelect.innerHTML+=`<option value="${m}">${name}</option>`;
}
monthSelect.value=now.getMonth()+1;

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSelect.innerHTML+=`<option>${y}</option>`;
}
yearSelect.value=now.getFullYear();

function num(v){return parseFloat((v||"0").toString().replace(/[$,]/g,""))||0}
function money(x){return "$"+(Number(x)||0).toFixed(2)}
function stay(i,o){if(!i||!o)return"";let a=i.split("-"),b=o.split("-");return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2]}
function lastDay(y,m){return new Date(y,m,0).getDate()}

let propertyData={}
let globalTotals={}

async function runReport(){

propertyData={}
globalTotals={gross:0,acc:0,clean:0,pmc:0,expenses:0,draft:0,owner:0}

const file=document.getElementById("fileInput").files[0]
if(!file) return

const text=await file.text()
const rows=Papa.parse(text,{header:true,skipEmptyLines:true}).data

const owner=ownerSelect.value
const percent=owners[owner].percent
const type=owners[owner].type
const month=parseInt(monthSelect.value)
const year=parseInt(yearSelect.value)
const endDay=lastDay(year,month)

const statementDate=new Date(year,month,1)
const paymentDate=new Date(year,month,5)

rows.forEach(r=>{
if(!r["CHECK-IN DATE"])return
const rMonth=parseInt(r["CHECK-IN DATE"].split("-")[1])
const rYear=parseInt(r["CHECK-IN DATE"].split("-")[0])
if(rMonth!==month||rYear!==year)return

const listing=r["LISTING'S NICKNAME"]||"Unknown"
if(!propertyData[listing])propertyData[listing]={rows:[],expenses:[]}
propertyData[listing].rows.push(r)
})

let tablesHTML=""

Object.keys(propertyData).forEach(listing=>{

let pGross=0,pAcc=0,pClean=0,pPMC=0,pExpenses=0,pDraft=0,pOwner=0

tablesHTML+=`
<div class="property">
<div class="property-title">${listing}</div>
<div class="property-period">${month}/1/${year} - ${month}/${endDay}/${year}</div>

<table>
<tr>
<th>Reservation</th>
<th>Stay</th>
<th>Accommodation</th>
<th>PMC</th>
${type==="draft"?"<th>Cleaning</th><th>Draft</th>":"<th>Owner</th>"}
</tr>
`

propertyData[listing].rows.forEach(r=>{
let payout=num(r["TOTAL PAYOUT"])
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"])
let cleaning=num(r["CLEANING FARE"])
let pmc=acc*percent
let draft=pmc+cleaning
let ownerPay=acc-pmc

pGross+=payout
pAcc+=acc
pClean+=cleaning
pPMC+=pmc
pDraft+=draft
pOwner+=ownerPay

tablesHTML+=`
<tr>
<td>${r["CONFIRMATION CODE"]}</td>
<td>${stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])}</td>
<td>${money(acc)}</td>
<td>${money(pmc)}</td>
${type==="draft"
?`<td>${money(cleaning)}</td><td>${money(draft)}</td>`
:`<td>${money(ownerPay)}</td>`}
</tr>
`
})

tablesHTML+=`
<tr class="total-row">
<td>TOTAL</td><td></td>
<td>${money(pAcc)}</td>
<td>${money(pPMC)}</td>
${type==="draft"
?`<td>${money(pClean)}</td><td>${money(pDraft)}</td>`
:`<td>${money(pOwner)}</td>`}
</tr>
</table>
`

tablesHTML+=`
<div class="property-summary" id="summary-${listing}">
${type==="draft"
?`Total Property Payout: ${money(pGross)} | Total PMC: ${money(pPMC)} | Total Cleaning: ${money(pClean)} | Total Expenses: $0.00 | Balance Due: ${money(pDraft)}`
:`Total PMC: ${money(pPMC)} | Total Expenses: $0.00 | Due to Owner: ${money(pOwner)}`}
</div>
`

tablesHTML+=`
<table class="expense-table" id="expense-${listing}">
<tr>
<th>Type</th>
<th>Description</th>
<th>Amount</th>
<th>Action</th>
</tr>
<tr>
<td>
<select>
<option>Maintenance</option>
<option>Repair</option>
<option>Pool Cleaning</option>
<option>Pest Control</option>
<option>Purchase</option>
</select>
</td>
<td><input type="text"></td>
<td><input type="number" step="0.01"></td>
<td class="expense-controls">
<button onclick="addExpense('${listing}',this)">Add</button>
</td>
</tr>
</table>
</div>
`

globalTotals.gross+=pGross
globalTotals.acc+=pAcc
globalTotals.clean+=pClean
globalTotals.pmc+=pPMC
if(type==="draft")globalTotals.draft+=pDraft
else globalTotals.owner+=pOwner

})

document.getElementById("output").innerHTML=`
<div id="statement">
<div class="header">
<div>
<div class="company">OCEAN VACATIONS</div>
<div class="company-info">
www.oceanvacationsmb.com<br>
oceanvacationsmb@gmail.com<br>
843-222-6516
</div>
</div>
<div class="dates">
Statement Date: ${statementDate.toLocaleDateString()}<br>
Payment Date: ${paymentDate.toLocaleDateString()}
</div>
</div>

<div class="title">RESERVATION REPORT</div>
<div class="owner">${owner}</div>
<div class="period">${month}/1/${year} - ${month}/${endDay}/${year}</div>

<div class="summary-box">
<div class="summary">
${type==="draft"
?`
<div>Gross Payout<strong>${money(globalTotals.gross)}</strong></div>
<div>Accommodation<strong>${money(globalTotals.acc)}</strong></div>
<div>Cleaning<strong>${money(globalTotals.clean)}</strong></div>
<div>Expenses<strong>${money(globalTotals.expenses)}</strong></div>
<div>PMC<strong>${money(globalTotals.pmc)}</strong></div>
<div>Draft From Owner<strong>${money(globalTotals.draft)}</strong></div>
`
:`
<div>Accommodation<strong>${money(globalTotals.acc)}</strong></div>
<div>Expenses<strong>${money(globalTotals.expenses)}</strong></div>
<div>PMC<strong>${money(globalTotals.pmc)}</strong></div>
<div>Due to Owner<strong>${money(globalTotals.owner)}</strong></div>
`}
</div>
</div>

${tablesHTML}

</div>
`

document.getElementById("pdfBtn").disabled=false
}

function addExpense(listing,btn){

const row=btn.closest("tr")
const type=row.querySelector("select").value
const desc=row.querySelector("input[type=text]").value
const amt=parseFloat(row.querySelector("input[type=number]").value)||0
if(!amt)return

const table=document.getElementById(`expense-${listing}`)
const newRow=table.insertRow(table.rows.length-1)
newRow.innerHTML=`
<td>${type}</td>
<td>${desc}</td>
<td>${money(amt)}</td>
<td>
<button onclick="editExpense(this)">Edit</button>
<button onclick="deleteExpense(this,'${listing}',${amt})">Delete</button>
</td>
`

row.querySelector("input[type=text]").value=""
row.querySelector("input[type=number]").value=""
}

function deleteExpense(btn,listing,amt){
btn.closest("tr").remove()
}

function editExpense(btn){
alert("Edit logic can be added next if you want full inline editing.")
}

function downloadPDF(){
html2pdf().set({margin:5,jsPDF:{unit:"mm",format:"a4"}})
.from(document.getElementById("statement")).save("Reservation_Report.pdf")
}
</script>

</body>
</html>
