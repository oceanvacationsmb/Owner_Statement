<!DOCTYPE html>
<html>
<head>
<title>Reservation Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#ffffff;
color:#000;
}

.topbar{
background:#f3f3f3;
padding:12px;
display:flex;
justify-content:center;
gap:10px;
flex-wrap:wrap;
border-bottom:1px solid #ccc;
}

select,input,button{
padding:6px;
font-size:13px;
}

button{
background:black;
color:white;
border:none;
cursor:pointer;
}

.content{
max-width:1050px;
margin:auto;
padding:30px 20px;
}

.title{
font-size:32px;
font-weight:bold;
text-align:center;
}

.period{
text-align:center;
margin-top:5px;
font-size:14px;
}

.owner{
font-size:34px;
font-weight:bold;
text-align:center;
margin-top:10px;
}

.meta{
text-align:center;
font-size:14px;
margin-top:5px;
}

.summary{
display:flex;
justify-content:center;
gap:50px;
margin:25px 0;
flex-wrap:wrap;
}

.summary div{
text-align:center;
font-size:14px;
}

.summary span{
display:block;
font-size:20px;
font-weight:bold;
margin-top:3px;
}

.property{
margin-top:40px;
page-break-inside:avoid;
}

.property h3{
margin-bottom:3px;
}

.property small{
display:block;
margin-bottom:8px;
font-size:13px;
}

table{
width:100%;
border-collapse:collapse;
margin-top:8px;
font-size:13px;
}

th,td{
border:1px solid #000;
padding:5px;
text-align:center;
}

th{
background:#000;
color:#fff;
}

tr:nth-child(even){
background:#f2f2f2;
}

.total{
font-weight:bold;
}

.expense-btn{
margin-top:8px;
background:#444;
color:#fff;
padding:5px 8px;
font-size:12px;
}

.delete-btn{
background:red;
color:white;
border:none;
padding:3px 6px;
cursor:pointer;
font-size:12px;
}

@media print{
.topbar{display:none}
.property{page-break-before:always}
}
</style>
</head>

<body>

<div class="topbar">
<select id="owner"></select>
<select id="month"></select>
<select id="year"></select>
<select id="percent" disabled></select>
<select id="type" disabled></select>
<input type="file" id="fileInput" accept=".csv">
<button onclick="runStatement()">Run Report</button>
<button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="output" class="content"></div>

<script>
const owners={
"ERAN":{percent:0.12,type:"Draft"},
"GHO":{percent:0.10,type:"Payout"}
};

const ownerSel=document.getElementById("owner");
const percentSel=document.getElementById("percent");
const typeSel=document.getElementById("type");

Object.keys(owners).forEach(o=>{
ownerSel.innerHTML+=`<option value="${o}">${o}</option>`;
});

ownerSel.onchange=()=>{
let o=owners[ownerSel.value];
percentSel.innerHTML=`<option>${o.percent*100}%</option>`;
typeSel.innerHTML=`<option>${o.type}</option>`;
};
ownerSel.onchange();

const monthSel=document.getElementById("month");
const yearSel=document.getElementById("year");
const now=new Date();

for(let i=0;i<12;i++){
monthSel.innerHTML+=`<option value="${i+1}">${new Date(0,i).toLocaleString('default',{month:'long'})}</option>`;
}
monthSel.value=now.getMonth()+1;

for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){
yearSel.innerHTML+=`<option>${y}</option>`;
}
yearSel.value=now.getFullYear();

let expenses = JSON.parse(localStorage.getItem("statement_expenses") || "{}");

function saveExpenses(){
localStorage.setItem("statement_expenses",JSON.stringify(expenses));
}

function money(v){return "$"+Number(v).toFixed(2);}
function num(v){return parseFloat(v)||0;}

function normalizePlatform(p){
p=(p||"").toLowerCase();
if(p.includes("manual")) return "Direct";
if(p.includes("vrbo")) return "VRBO";
return p.charAt(0).toUpperCase()+p.slice(1);
}

function fullPeriod(month,year){
let start=new Date(year,month-1,1);
let end=new Date(year,month,0);
return start.toLocaleDateString("en-US",{month:"long",day:"numeric"})+" â€“ "+
end.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
}

async function runStatement(){

const file=document.getElementById("fileInput").files[0];
if(!file){alert("Upload CSV");return;}

const text=await file.text();
const data=Papa.parse(text,{header:true}).data;

const owner=ownerSel.value;
const {percent,type}=owners[owner];
const month=parseInt(monthSel.value);
const year=parseInt(yearSel.value);

let grouped={};
data.forEach(r=>{
if(!r["CHECK-IN DATE"]) return;
let m=parseInt(r["CHECK-IN DATE"].split("-")[1]);
let y=parseInt(r["CHECK-IN DATE"].split("-")[0]);
if(m!==month||y!==year) return;
let listing=r["LISTING'S NICKNAME"]||"Unknown";
if(!grouped[listing]) grouped[listing]=[];
grouped[listing].push(r);
});

let totalAcc=0,totalPMC=0,totalClean=0,totalExpense=0,totalOwner=0,totalDraft=0;

let html=`
<div id="statement">
<div class="title">RESERVATION REPORT</div>
<div class="period">${fullPeriod(month,year)}</div>
<div class="owner">${owner}</div>
<div class="meta">Rate: ${percent*100}% | Type: ${type}</div>
`;

for(let listing in grouped){

if(!expenses[listing]) expenses[listing]=[];

let rows="";
let pAcc=0,pPMC=0,pClean=0,pOwner=0,pDraft=0,pTotalPayout=0;

grouped[listing].forEach(r=>{
let acc=num(r["ACCOMMODATION FARE"])-num(r["MARKUP"]);
let clean=num(r["CLEANING FARE"]);
let payout=num(r["TOTAL PAYOUT"]);
let pmc=acc*percent;
let ownerPay=acc-pmc;
let draft=pmc+clean;

pAcc+=acc;
pPMC+=pmc;
pClean+=clean;
pTotalPayout+=payout;

if(type==="Payout") pOwner+=ownerPay;
else pDraft+=draft;

rows+=`
<tr>
<td>${r["CONFIRMATION CODE"]}</td>
<td>${normalizePlatform(r["PLATFORM"])}</td>
<td>${r["CHECK-IN DATE"]} - ${r["CHECK-OUT DATE"]}</td>
<td>${money(acc)}</td>
<td>${money(pmc)}</td>
<td>${type==="Payout"?money(ownerPay):money(draft)}</td>
</tr>`;
});

let expRows="";
let expTotal=0;

expenses[listing].forEach((e,i)=>{
expTotal+=num(e.amount);
expRows+=`
<tr>
<td>
<select onchange="updateExpense('${listing}',${i},'type',this.value)">
<option ${e.type==="Maintenance"?"selected":""}>Maintenance</option>
<option ${e.type==="Repair"?"selected":""}>Repair</option>
<option ${e.type==="Pool Cleaning"?"selected":""}>Pool Cleaning</option>
<option ${e.type==="Pest Control"?"selected":""}>Pest Control</option>
<option ${e.type==="Purchase"?"selected":""}>Purchase</option>
</select>
</td>
<td><input value="${e.desc}" onchange="updateExpense('${listing}',${i},'desc',this.value)"></td>
<td><input type="number" value="${e.amount}" onchange="updateExpense('${listing}',${i},'amount',this.value)"></td>
<td><input type="file" onchange="updateExpense('${listing}',${i},'file',this.files[0]?.name||'')"></td>
<td><button class="delete-btn" onclick="deleteExpense('${listing}',${i})">Delete</button></td>
</tr>`;
});

totalAcc+=pAcc;
totalPMC+=pPMC;
totalClean+=pClean;
totalExpense+=expTotal;

if(type==="Payout") totalOwner+=pOwner-expTotal;
else totalDraft+=pDraft+expTotal;

html+=`
<div class="property">
<h3>${listing}</h3>
<small>${fullPeriod(month,year)}</small>

<table>
<tr>
<th>Reservation</th>
<th>Platform</th>
<th>Stay</th>
<th>Accommodation</th>
<th>PMC</th>
<th>${type==="Payout"?"Owner Payout":"Draft"}</th>
</tr>
${rows}
<tr class="total">
<td colspan="3">TOTAL</td>
<td>${money(pAcc)}</td>
<td>${money(pPMC)}</td>
<td>${type==="Payout"?money(pOwner-expTotal):money(pDraft+expTotal)}</td>
</tr>
${type==="Draft"?`
<tr>
<td colspan="5">Total Payout</td>
<td>${money(pTotalPayout)}</td>
</tr>`:""}
</table>

<h4>Expenses</h4>
<table>
<tr><th>Type</th><th>Description</th><th>Amount</th><th>Invoice</th><th></th></tr>
${expRows}
</table>

<button class="expense-btn" onclick="addExpense('${listing}')">+ Add Expense</button>
</div>
`;
}

html+=`
<div class="summary">
<div>Accommodation<span>${money(totalAcc)}</span></div>
<div>PMC<span>${money(totalPMC)}</span></div>
${type==="Draft"?`<div>Cleaning Fee<span>${money(totalClean)}</span></div>`:""}
<div>Expenses<span>${money(totalExpense)}</span></div>
<div>${type==="Payout"?"Owner Payout":"Draft From Owner"}<span>${type==="Payout"?money(totalOwner):money(totalDraft)}</span></div>
</div>
</div>`;

document.getElementById("output").innerHTML=html;
saveExpenses();
}

function addExpense(listing){
expenses[listing].push({type:"Maintenance",desc:"",amount:0,file:""});
saveExpenses();
runStatement();
}

function updateExpense(listing,index,field,value){
expenses[listing][index][field]=value;
saveExpenses();
runStatement();
}

function deleteExpense(listing,index){
expenses[listing].splice(index,1);
saveExpenses();
runStatement();
}

function downloadPDF(){
const el=document.getElementById("statement");
html2pdf().set({
margin:10,
filename:"Reservation_Report.pdf",
html2canvas:{scale:2},
jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
}).from(el).save();
}
</script>

</body>
</html>
