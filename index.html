<script>

const monthSelect=document.getElementById("month");
const yearSelect=document.getElementById("year");
const now=new Date();
const currentMonth=now.getMonth()+1;
const currentYear=now.getFullYear();

for(let m=1;m<=12;m++){
 let mm=m.toString().padStart(2,"0");
 let name=new Date(0,m-1).toLocaleString('default',{month:'long'});
 monthSelect.innerHTML+=`<option value="${mm}">${name}</option>`;
}
monthSelect.value=currentMonth.toString().padStart(2,"0");

for(let y=currentYear-3;y<=currentYear+3;y++){
 yearSelect.innerHTML+=`<option value="${y}">${y}</option>`;
}
yearSelect.value=currentYear;

function num(v){
 return parseFloat((v||"0").toString().replace(/[$,]/g,''))||0;
}

function stay(i,o){
 if(!i||!o) return "";
 let a=i.split("-");
 let b=o.split("-");
 return a[1]+"/"+a[2]+" - "+b[1]+"/"+b[2];
}

function lastDay(year,month){
 return new Date(year, month, 0).getDate();
}

function generate(){

let file=document.getElementById("csvFile").files[0];
if(!file){ alert("Upload CSV first"); return; }

let month=monthSelect.value;
let year=yearSelect.value;
let owner=document.getElementById("owner").value;
let percent=parseFloat(document.getElementById("percent").value);
let ownerType=document.getElementById("ownerType").value;
let endDay=lastDay(year,month);

Papa.parse(file,{
header:true,
skipEmptyLines:true,
complete:function(result){

let rows=result.data;
let grouped={};

let totalTrue=0;
let totalMgmt=0;
let totalCleaning=0;
let totalOwner=0;
let totalDraft=0;
let totalTax=0;

/* GROUP ROWS */
rows.forEach(function(r){

if(num(r["CANCELED TOTAL PAYOUT"])!==0) return;
if(!r["CHECK-IN DATE"]) return;

let checkMonth=r["CHECK-IN DATE"].substring(5,7);
let checkYear=r["CHECK-IN DATE"].substring(0,4);

if(checkMonth!==month || checkYear!==year.toString()) return;

let listing=r["LISTING'S NICKNAME"]||"Unknown";

if(!grouped[listing]) grouped[listing]=[];
grouped[listing].push(r);

});

/* HEADER */
let html=`
<div class="title">RESERVATION STATEMENT</div>
<div class="period">
${new Date(year,month-1).toLocaleString('default',{month:'long'})} 1 - 
${new Date(year,month-1).toLocaleString('default',{month:'long'})} ${endDay}, ${year}
</div>
<div class="owner">${owner}</div>
`;

/* TABLES */
let tablesHTML="";

Object.keys(grouped).forEach(function(listing){

let propertyTrue=0;
let propertyMgmt=0;
let propertyCleaning=0;
let propertyOwner=0;
let propertyDraft=0;

let table=`
<div class="property-section">
<div class="property-title">üè† ${listing}</div>
<table>
<tr>
<th>Reservation ID</th>
<th>Platform</th>
<th>Stay</th>
<th>True Accommodation</th>
<th>PMC</th>
${ownerType==="pmc"?"<th>Owner Payout</th>":"<th>Cleaning</th><th>Draft From Owner</th>"}
</tr>
`;

grouped[listing].forEach(function(r){

let acc=num(r["ACCOMMODATION FARE"]);
let markup=num(r["MARKUP"]);
let cleaning=num(r["CLEANING FARE"]);
let city=num(r["CITY TAX"]);
let state=num(r["STATE TAX"]);
let county=num(r["COUNTY TAX"]);
let occ=num(r["OCCUPANCY TAX"]);

let trueAcc=acc-markup;
let mgmt=trueAcc*percent;
let ownerPay=trueAcc-mgmt;
let draft=mgmt+cleaning;

propertyTrue+=trueAcc;
propertyMgmt+=mgmt;
propertyCleaning+=cleaning;
propertyOwner+=ownerPay;
propertyDraft+=draft;

totalTrue+=trueAcc;
totalMgmt+=mgmt;
totalCleaning+=cleaning;
totalTax+=city+state+county+occ;

if(ownerType==="pmc"){
 totalOwner+=ownerPay;
}else{
 totalDraft+=draft;
}

table+=`
<tr>
<td class="left">${r["CONFIRMATION CODE"]||""}</td>
<td class="left">${r["PLATFORM"]||""}</td>
<td>${stay(r["CHECK-IN DATE"],r["CHECK-OUT DATE"])}</td>
<td>$${trueAcc.toFixed(2)}</td>
<td>$${mgmt.toFixed(2)}</td>
${ownerType==="pmc"
 ? `<td>$${ownerPay.toFixed(2)}</td>`
 : `<td>$${cleaning.toFixed(2)}</td><td>$${draft.toFixed(2)}</td>`}
</tr>`;
});

table+=`
<tr class="total-row">
<td class="left">TOTAL</td><td></td><td></td>
<td>$${propertyTrue.toFixed(2)}</td>
<td>$${propertyMgmt.toFixed(2)}</td>
${ownerType==="pmc"
 ? `<td>$${propertyOwner.toFixed(2)}</td>`
 : `<td>$${propertyCleaning.toFixed(2)}</td><td>$${propertyDraft.toFixed(2)}</td>`}
</tr>
</table>
</div>
`;

tablesHTML+=table;

});

/* SUMMARY */
let summary=`
<div class="summary">
<div class="summary-box">TRUE ACCOMMODATION<span>$${totalTrue.toFixed(2)}</span></div>
<div class="summary-box">PMC COMMISSION<span>$${totalMgmt.toFixed(2)}</span></div>
<div class="summary-box">TOTAL TAX<span>$${totalTax.toFixed(2)}</span></div>
${ownerType==="pmc"
 ? `<div class="summary-box">OWNER PAYOUT<span>$${totalOwner.toFixed(2)}</span></div>`
 : `<div class="summary-box">DRAFT FROM OWNER<span>$${totalDraft.toFixed(2)}</span></div>`}
</div>
`;

document.getElementById("output").innerHTML = html + summary + tablesHTML;

}
});

}

</script>
