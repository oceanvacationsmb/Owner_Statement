<!DOCTYPE html>
<html>
<head>
    <title>Owner Draft Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Arial; padding: 40px; background: #f2f4f7; }
        input, select { padding: 10px; margin: 10px 0; width: 400px; }
        button { padding: 12px 25px; background: #2c7be5; color: white; border: none; cursor: pointer; font-size: 16px; }
        .result { margin-top: 30px; padding: 25px; background: white; border-radius: 10px; }
        table { width: 100%; margin-top: 30px; border-collapse: collapse; background: white; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: right; }
        th { background: #f0f0f0; }
        .debug { margin-top:20px; font-size:13px; color:#666; }
    </style>
</head>
<body>

<h1>Owner Draft Recalculation Tool</h1>

<input type="file" id="csvFile" accept=".csv"><br>
<input type="number" id="percent" value="12"><br>

<select id="ownerType">
    <option value="direct">Direct Payout</option>
    <option value="pmc">PMC Holds Payout</option>
</select><br>

<button onclick="processCSV()">Calculate</button>

<div class="result" id="summary"></div>
<div id="tableContainer"></div>
<div class="debug" id="debug"></div>

<script>
function cleanNumber(value) {
    if (!value) return 0;
    return parseFloat(value.toString().replace(/[$,]/g, '')) || 0;
}

function findColumn(headers, possibleNames) {
    for (let name of possibleNames) {
        let found = headers.find(h => h.trim().toUpperCase() === name);
        if (found) return found;
    }
    return null;
}

function processCSV() {

    const file = document.getElementById('csvFile').files[0];
    const percent = parseFloat(document.getElementById('percent').value) / 100;
    const ownerType = document.getElementById('ownerType').value;

    if (!file) {
        alert("Upload CSV first");
        return;
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {

            const data = results.data;
            const headers = results.meta.fields;

            document.getElementById("debug").innerHTML =
                "<strong>Detected Columns:</strong><br>" + headers.join("<br>");

            const accCol = findColumn(headers, ["ACCOMMODATION FARE"]);
            const markupCol = findColumn(headers, ["MARKUP"]);
            const cleaningCol = findColumn(headers, ["CLEANING FARE"]);
            const payoutCol = findColumn(headers, ["TOTAL PAYOUT"]);
            const resCol = headers[0];

            if (!accCol || !payoutCol) {
                document.getElementById("summary").innerHTML =
                    "<strong>ERROR:</strong> Required columns not found. Check debug list below.";
                return;
            }

            let totalBase = 0;
            let totalManagement = 0;
            let totalCleaning = 0;
            let totalPayout = 0;
            let totalMarkup = 0;

            let tableHTML = `
                <table>
                <tr>
                    <th style="text-align:left">Reservation</th>
                    <th>Accommodation</th>
                    <th>Markup</th>
                    <th>True Base</th>
                    <th>Management</th>
                    <th>Cleaning</th>
                    <th>Payout</th>
                </tr>
            `;

            data.forEach(row => {

                const acc = cleanNumber(row[accCol]);
                const markup = cleanNumber(row[markupCol]);
                const cleaning = cleanNumber(row[cleaningCol]);
                const payout = cleanNumber(row[payoutCol]);

                const trueBase = acc - markup;
                const management = trueBase * percent;

                totalBase += trueBase;
                totalManagement += management;
                totalCleaning += cleaning;
                totalPayout += payout;
                totalMarkup += markup;

                tableHTML += `
                    <tr>
                        <td style="text-align:left">${row[resCol] || ""}</td>
                        <td>$${acc.toFixed(2)}</td>
                        <td>$${markup.toFixed(2)}</td>
                        <td>$${trueBase.toFixed(2)}</td>
                        <td>$${management.toFixed(2)}</td>
                        <td>$${cleaning.toFixed(2)}</td>
                        <td>$${payout.toFixed(2)}</td>
                    </tr>
                `;
            });

            tableHTML += "</table>";

            let summaryHTML = `
                <h3>Summary</h3>
                Total True Accommodation: $${totalBase.toFixed(2)}<br>
                Total Management: $${totalManagement.toFixed(2)}<br>
                Total Cleaning: $${totalCleaning.toFixed(2)}<br>
                Total Markup: $${totalMarkup.toFixed(2)}<br><br>
            `;

            if (ownerType === "direct") {
                summaryHTML += `<strong>Amount To Draft From Owner: $${(totalManagement + totalCleaning).toFixed(2)}</strong>`;
            } else {
                summaryHTML += `<strong>Amount To Pay Owner: ${(totalPayout - totalManagement - totalCleaning).toFixed(2)}</strong>`;
            }

            document.getElementById("summary").innerHTML = summaryHTML;
            document.getElementById("tableContainer").innerHTML = tableHTML;
        }
    });
}
</script>

</body>
</html>
