<!DOCTYPE html>
<html>
<head>
    <title>Owner Draft Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Arial; padding: 40px; background: #f2f4f7; }
        h1 { color: #222; }
        input, select { padding: 10px; margin: 10px 0; width: 400px; }
        button { padding: 12px 25px; background: #2c7be5; color: white; border: none; cursor: pointer; font-size: 16px; }
        table { width: 100%; margin-top: 30px; border-collapse: collapse; background: white; font-size: 13px; }
        th, td { padding: 6px; border: 1px solid #ddd; text-align: right; }
        th { background: #f0f0f0; }
        td.left { text-align: left; }
        .section { margin-top: 30px; padding: 25px; background: white; border-radius: 10px; }
    </style>
</head>
<body>

<h1>Owner Draft Recalculation Tool</h1>

<label>Upload Guesty CSV:</label><br>
<input type="file" id="csvFile" accept=".csv"><br>

<label>Owner Management %:</label><br>
<input type="number" id="percent" value="12"><br>

<button onclick="processCSV()">Calculate</button>

<div id="summary" class="section"></div>
<div id="taxSection" class="section"></div>
<div id="pmcSection" class="section"></div>
<div id="tableContainer"></div>

<script>

function cleanNumber(value) {
    if (!value) return 0;
    return parseFloat(value.toString().replace(/[$,]/g, '')) || 0;
}

function formatDate(dateStr) {
    if (!dateStr) return "";
    const parts = dateStr.split("-");
    if (parts.length !== 3) return "";
    return parts[1] + "/" + parts[2];
}

function processCSV() {

    const file = document.getElementById('csvFile').files[0];
    const percent = parseFloat(document.getElementById('percent').value) / 100;

    if (!file) {
        alert("Upload CSV first");
        return;
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {

            const data = results.data;

            let totalTrueBase = 0;
            let totalManagement = 0;
            let totalCleaning = 0;
            let totalPayout = 0;

            let totalCityTax = 0;
            let totalStateTax = 0;
            let totalCountyTax = 0;
            let totalOccupancyTax = 0;

            let hasDate = false;

            data.forEach(row => {
                if (row["CHECK-IN DATE"] || row["CHECK-OUT DATE"]) {
                    hasDate = true;
                }
            });

            let tableHTML = "<table><tr>";
            tableHTML += "<th>Listing</th>";
            tableHTML += "<th>Confirmation</th>";
            tableHTML += "<th>Platform</th>";
            if (hasDate) tableHTML += "<th>Stay</th>";
            tableHTML += "<th>Accommodation</th>";
            tableHTML += "<th>Markup</th>";
            tableHTML += "<th>True Accommodation</th>";
            tableHTML += "<th>Cleaning</th>";
            tableHTML += "<th>City Tax</th>";
            tableHTML += "<th>State Tax</th>";
            tableHTML += "<th>County Tax</th>";
            tableHTML += "<th>Occupancy Tax</th>";
            tableHTML += "</tr>";

            data.forEach(row => {

                if (cleanNumber(row["CANCELED TOTAL PAYOUT"]) !== 0) return;

                const acc = cleanNumber(row["ACCOMMODATION FARE"]);
                const adjustment = cleanNumber(row["ACCOMMODATION FARE ADJUSTMENT"]);
                const markup = cleanNumber(row["MARKUP"]);
                const cleaning = cleanNumber(row["CLEANING FARE"]);
                const payout = cleanNumber(row["TOTAL PAYOUT"]);

                const cityTax = cleanNumber(row["CITY TAX"]);
                const stateTax = cleanNumber(row["STATE TAX"]);
                const countyTax = cleanNumber(row["COUNTY TAX"]);
                const occupancyTax = cleanNumber(row["OCCUPANCY TAX"]);

                const trueBase = (acc + adjustment) - markup;
                const management = trueBase * percent;

                totalTrueBase += trueBase;
                totalManagement += management;
                totalCleaning += cleaning;
                totalPayout += payout;

                totalCityTax += cityTax;
                totalStateTax += stateTax;
                totalCountyTax += countyTax;
                totalOccupancyTax += occupancyTax;

                tableHTML += "<tr>";
                tableHTML += "<td class='left'>" + (row["LISTING'S NICKNAME"] || "") + "</td>";
                tableHTML += "<td class='left'>" + (row["CONFIRMATION CODE"] || "") + "</td>";
                tableHTML += "<td class='left'>" + (row["PLATFORM"] || "") + "</td>";

                if (hasDate) {
                    const stay = formatDate(row["CHECK-IN DATE"]) + " - " + formatDate(row["CHECK-OUT DATE"]);
                    tableHTML += "<td>" + stay + "</td>";
                }

                tableHTML += "<td>$" + acc.toFixed(2) + "</td>";
                tableHTML += "<td>$" + markup.toFixed(2) + "</td>";
                tableHTML += "<td>$" + trueBase.toFixed(2) + "</td>";
                tableHTML += "<td>$" + cleaning.toFixed(2) + "</td>";
                tableHTML += "<td>$" + cityTax.toFixed(2) + "</td>";
                tableHTML += "<td>$" + stateTax.toFixed(2) + "</td>";
                tableHTML += "<td>$" + countyTax.toFixed(2) + "</td>";
                tableHTML += "<td>$" + occupancyTax.toFixed(2) + "</td>";
                tableHTML += "</tr>";
            });

            tableHTML += "</table>";

            // SUMMARY
            let summaryHTML = "<h3>Summary</h3>";
            summaryHTML += "Total True Accommodation: $" + totalTrueBase.toFixed(2) + "<br>";
            summaryHTML += "<strong>Amount To Pay Owner: $" + (totalPayout - totalManagement - totalCleaning).toFixed(2) + "</strong>";

            // TAX SECTION
            let taxHTML = "<h3>Taxes</h3>";
            taxHTML += "Total City Tax: $" + totalCityTax.toFixed(2) + "<br>";
            taxHTML += "Total State Tax: $" + totalStateTax.toFixed(2) + "<br>";
            taxHTML += "Total County Tax: $" + totalCountyTax.toFixed(2) + "<br>";
            taxHTML += "Total Occupancy Tax: $" + totalOccupancyTax.toFixed(2);

            // PMC TRANSFER
            let pmcHTML = "<h3>PMC Transfer</h3>";
            pmcHTML += "Total Management Commission: $" + totalManagement.toFixed(2) + "<br>";
            pmcHTML += "Total Amount To Report Taxes (Total Payout): $" + totalPayout.toFixed(2);

            document.getElementById("summary").innerHTML = summaryHTML;
            document.getElementById("taxSection").innerHTML = taxHTML;
            document.getElementById("pmcSection").innerHTML = pmcHTML;
            document.getElementById("tableContainer").innerHTML = tableHTML;
        }
    });
}

</script>

</body>
</html>
